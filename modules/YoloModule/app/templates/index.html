<html>

<head>
  <title>Video Stream</title>
  <meta http-equiv="content-type" charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- <script type="module" src="./drawApp.js"></script> -->
  <link rel="stylesheet" href="custom.css">
</head>

<body>
  <div class="outsideWrapper">
    <div class="insideWrapper">
      <img id="currentImage" class="coveredImage">
      <canvas id="canvas" class="coveringCanvas"></canvas>
    </div>
  </div>

  <script type="module">
    import DrawLines from "./drawApp.js"
    import WSMessage from "./WSMessage.js"

    var initialLines = { "lines": [{ "start": { "x": 765, "y": 923 }, "end": { "x": 673, "y": 1063 } }], "frameSize": [0, 0, 1664, 1248], "scale": { "x": 0.9909855769230769, "y": 0.9911858974358975 } };
    var img = document.getElementById("currentImage");
    var canvas = document.getElementById("canvas");
    let init = true;
    let liner = new DrawLines(canvas, img);
    let CURRENTSTATES = { 'RulesEdit': false };

    var url = document.URL.replace("http", "ws");

    try {
      var callbackForDrawing = (event) => {
        img.onload = () => {
          if (init) {
            liner.initObject();
            liner.setLines = initialLines;
            init = false;
          }
          liner.setUpCanvas();
          liner.refreshCanvas();
        }

        liner.resizeWindow();
      }

      var ws = new WebSocket(url + "stream");
      //ws.binaryType = "arraybuffer";
      ws.onerror = (event) => {
        console.log("Fehler WS");
        callbackForDrawing(event)
      };

      ws.onopen = function () {
        console.log("connection was established");
        var command = { 'name': 'next' };
        var msg = new WSMessage('command', command);
        ws.send(JSON.stringify(msg));
      };

      ws.onmessage = function (msg) {
        var m = WSMessage.fromText(msg.data);
        if (m.Type == "image") {
          img.src = "data:image/png;base64, " + m.Payload;
        }

        if (m.Type == "mode") {
          if (m.Payload.ModeName == 'RulesEdit') {
            CURRENTSTATES.RulesEdit = m.Payload.Value;
            liner.enabled = m.Payload.Value;
          }
          let report = new WSMessage('report', CURRENTSTATES)
          ws.send(JSON.stringify(report));
        }
      };

      img.onload = function () {
        if (init) {
          liner.initObject();
          liner.setLines = initialLines;
          init = false;
          command = { 'name': 'initLines', 'content': liner.lineCollection };
          msg = new WSMessage('command', command);
          ws.send(JSON.stringify(msg));
        }
        liner.setUpCanvas();
        liner.refreshCanvas();

        var command = { 'name': 'next' }
        var msg = new WSMessage('command', command);
        ws.send(JSON.stringify(msg));
      };

    } catch {
      console.log("WebSocket Connection could not be established");
      callbackForDrawing();
    }

    function keyUpListener(event) {
      event = event || window.event;
      if (event.key == "Delete") { // delete line
        liner.removeCurrentLine();
      }
      if (event.key == "s") { // save current drawing
        console.log(liner.lineCollection);
        let command = { 'name': 'save', 'content': liner.lineCollection };
        let msg = new WSMessage('command', command);
        ws.send(JSON.stringify(msg));
      }
    }
    document.addEventListener("keyup", keyUpListener);
  </script>
</body>

</html>